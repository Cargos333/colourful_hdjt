{% extends 'admin/admin_base.html' %}

{% block title %}Gestion des Produits - Colourful HDJT{% endblock %}

{% block page_title %}Produits{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header avec bouton d'ajout -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Gestion des Produits</h2>
            <p class="text-gray-600 mt-1">{{ products.total }} produit{{ 's' if products.total > 1 else '' }} au total</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('admin_dashboard') }}" class="btn-admin-secondary">
                <i class="fas fa-tachometer-alt mr-2"></i>Retour au Dashboard
            </a>
            <a href="{{ url_for('admin_product_add') }}" class="btn-admin-primary">
                <i class="fas fa-plus mr-2"></i>Ajouter un produit
            </a>
        </div>
    </div>

    <!-- Statistiques des produits -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total produits -->
        <div class="admin-card p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-box text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Produits</p>
                    <p class="text-2xl font-bold text-gray-900">{{ products.total if products else 0 }}</p>
                </div>
            </div>
        </div>

        <!-- Produits personnalisables -->
        <div class="admin-card p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-shopping-bag text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Produits Publics</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {% set public_count = 0 %}
                        {% if products and products.items %}
                            {% for product in products.items %}
                                {% if not product.is_internal %}
                                    {% set public_count = public_count + 1 %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                        {{ public_count }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Prix moyen -->
        <div class="admin-card p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-euro-sign text-purple-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Prix Moyen</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {% if products and products.items %}
                            {% set total = 0 %}
                            {% set count = 0 %}
                            {% for product in products.items %}
                                {% if not product.is_internal %}
                                    {% set total = total + product.price %}
                                    {% set count = count + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% if count > 0 %}
                                {{ "%.2f"|format(total / count) }} KMF
                            {% else %}
                                0.00 KMF
                            {% endif %}
                        {% else %}
                            0.00 KMF
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Catégories utilisées -->
        <div class="admin-card p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                    <i class="fas fa-tags text-orange-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-600">Catégories</p>
                    <p class="text-2xl font-bold text-gray-900">{{ categories|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="admin-card p-4">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-64">
                <form method="GET" action="{{ url_for('admin_products') }}" class="flex gap-2">
                    <input type="text" name="search" value="{{ request.args.get('search', '') }}" placeholder="Rechercher par nom, description..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <select name="category" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Toutes les catégories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {{ 'selected' if category_filter == category.id else '' }}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="fas fa-search mr-2"></i>Rechercher
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Table des produits -->
    <div class="admin-card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-purple-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Produit</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Catégories</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Prix</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Stock Initial</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Stock Actuel</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Vendu</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Personnalisable</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-purple-700 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if products and products.items %}
                    {% for product in products.items %}
                    <tr class="hover:bg-purple-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                {% if product.image_url %}
                                <img class="w-10 h-10 rounded-lg object-cover mr-3" src="{{ product.image_url }}" alt="{{ product.name }}">
                                {% else %}
                                <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-image text-gray-400"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="text-sm font-medium text-gray-900">{{ product.name }}</div>
                                    {% if product.description %}
                                    <div class="text-sm text-gray-500 truncate max-w-xs">{{ product.description }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if product.categories %}
                                {% set product_categories = product.categories | from_json %}
                                {% if product_categories %}
                                    <div class="flex flex-wrap gap-1">
                                        {% for cat_id in product_categories %}
                                            {% set category = categories | selectattr('id', 'equalto', cat_id) | first %}
                                            {% if category %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    {{ category.name }}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-sm text-gray-500">-</span>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-500">-</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ "%.2f"|format(product.price) }} KMF</div>
                            {% if product.container_type %}
                            <div class="text-sm text-gray-500">+{{ "%.2f"|format(product.container_type.base_price) }} KMF contenant</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ product.initial_stock or 0 }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ product.current_stock or 0 }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ (product.initial_stock or 0) - (product.current_stock or 0) }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if product.is_internal %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                <i class="fas fa-building mr-1"></i>Interne
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-globe mr-1"></i>Public
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if product.is_customizable %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Oui
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                <i class="fas fa-times mr-1"></i>Non
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <a href="{{ url_for('admin_product_detail', product_id=product.id) }}" class="text-indigo-600 hover:text-indigo-900" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('admin_product_edit', product_id=product.id) }}" class="text-blue-600 hover:text-blue-900" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{{ url_for('admin_product_delete', product_id=product.id) }}" class="inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')">
                                    <button type="submit" class="text-red-600 hover:text-red-900 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                    {% if not products or not products.items %}
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                            Aucun produit trouvé
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if products and products.pages > 1 %}
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Affichage de {{ products.page * products.per_page - products.per_page + 1 if products.page and products.per_page else 1 }} à {{ [products.page * products.per_page, products.total]|min if products.page and products.per_page and products.total else 0 }} sur {{ products.total if products.total else 0 }} résultats
                </div>
                <div class="flex items-center space-x-2">
                    {% if products.has_prev %}
                    <a href="{{ url_for('admin_products', page=products.prev_num, search=search_query, category=category_filter) }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors">
                        Précédent
                    </a>
                    {% endif %}

                    {% for page_num in products.iter_pages() %}
                        {% if page_num %}
                            {% if page_num == products.page %}
                            <span class="px-3 py-1 border border-purple-500 rounded-md text-sm font-medium text-purple-600 bg-purple-50">{{ page_num }}</span>
                            {% else %}
                            <a href="{{ url_for('admin_products', page=page_num, search=search_query, category=category_filter) }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors">{{ page_num }}</a>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if products.has_next %}
                    <a href="{{ url_for('admin_products', page=products.next_num, search=search_query, category=category_filter) }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors">
                        Suivant
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Fonctionnalité de recherche en temps réel
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('input[placeholder="Rechercher par nom, description..."]');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const name = row.querySelector('td:nth-child(1) .text-sm.font-medium').textContent.toLowerCase();
            const description = row.querySelector('td:nth-child(1) .text-sm.text-gray-500')?.textContent.toLowerCase() || '';

            if (name.includes(searchTerm) || description.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
});
{% endblock %}