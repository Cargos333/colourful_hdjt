{% extends "base.html" %}

{% block title %}Personnaliser {{ produit.nom }} - COLOURFUL HDJT{% endblock %}

{% block content %}
<div class="container">
    <div class="personalization-container">
        <div class="product-header">
            <div class="product-image-column">
                <div class="product-image-container">
                    <img src="{{ produit.image or '/static/images/default-container.svg' }}" alt="{{ produit.nom }}" class="product-image">
                </div>
            </div>
            
            <div class="product-details-column">
                <div class="product-meta">
                    <span class="product-badge">
                        <i class="fas fa-magic"></i> Personnalisable
                    </span>
                    {% if produit.type == 'container' %}
                    <span class="container-type-badge">
                        <i class="fas fa-box"></i> Contenant
                    </span>
                    {% endif %}
                </div>
                
                <h1>{{ produit.nom }}</h1>
                
                <div class="product-description-section">
                    <p class="product-description">{{ produit.description }}</p>
                    
                    {% if produit.categories %}
                    <div class="product-categories">
                        <h3><i class="fas fa-tags"></i> Cat√©gories incluses</h3>
                        <div class="categories-list">
                            {% for categorie in produit.categories %}
                            <span class="category-tag">{{ categorie.replace('_', ' ')|title }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="product-price-column">
                <div class="price-section">
                    <div class="price-display">
                        <span class="current-price" id="current-price">{{ produit.prix|int }} KMF</span>
                        <span class="price-note">Prix fixe - personnalisation incluse</span>
                    </div>
                    
                    <div class="price-features">
                        <div class="feature-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Livraison gratuite</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Garantie qualit√©</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="personalization-form">
            <h2>Personnalisez votre {{ produit.nom.lower() }}</h2>
            <p>Choisissez les produits de votre choix dans chaque cat√©gorie. Le prix reste fixe !</p>

            <form id="personalization-form">
                {% for categorie_key, categorie_data in options_produits.items() %}
                <div class="accordion-section">
                    <button type="button" class="accordion-header" data-category="{{ categorie_key }}">
                        <span class="accordion-title">{{ categorie_data.nom }}</span>
                        <span class="accordion-subtitle">
                            {% if produit.quantite_par_categorie %}
                                Choisissez {{ produit.quantite_par_categorie }} produit{{ 's' if produit.quantite_par_categorie > 1 else '' }}
                            {% else %}
                                Choisissez vos produits
                            {% endif %}
                        </span>
                        <span class="accordion-icon">{% if loop.first %}‚ñ≤{% else %}‚ñº{% endif %}</span>
                    </button>
                    <div class="accordion-content{% if loop.first %} open{% endif %}">
                        <div class="options-grid">
                            {% if produit.quantite_par_categorie %}
                            <!-- S√©lection multiple pour les quantit√©s -->
                            {% for option in categorie_data.options %}
                            <div class="option-card">
                                <input type="checkbox" id="option-{{ option.id }}" name="{{ categorie_key }}" value="{{ option.nom }}" data-price="{{ option.prix }}" class="category-checkbox">
                                <label for="option-{{ option.id }}" class="option-label">
                                    <div class="option-image">
                                        <img src="{{ option.image }}" alt="{{ option.nom }}">
                                    </div>
                                    <div class="option-info">
                                        <h4>{{ option.nom }}</h4>
                                        <p>{{ option.marque }}</p>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                            {% else %}
                            <!-- S√©lection unique pour les autres cat√©gories -->
                            {% for option in categorie_data.options %}
                            <div class="option-card">
                                <input type="radio" id="option-{{ option.id }}" name="{{ categorie_key }}" value="{{ option.nom }}" data-price="{{ option.prix }}" class="category-radio">
                                <label for="option-{{ option.id }}" class="option-label">
                                    <div class="option-image">
                                        <img src="{{ option.image }}" alt="{{ option.nom }}">
                                    </div>
                                    <div class="option-info">
                                        <h4>{{ option.nom }}</h4>
                                        <p>{{ option.marque }}</p>
                                    </div>
                                </label>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}

                <div class="quantity-section">
                    <label for="quantite">Quantit√©:</label>
                    <input type="number" id="quantite" name="quantite" value="1" min="1" max="10">
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn-secondary" onclick="window.history.back()">Retour</button>
                    <button type="submit" class="btn-primary">Ajouter au panier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('personalization-form');
    const currentPriceElement = document.getElementById('current-price');
    const basePrice = {{ produit.prix }};
    const quantityInput = document.getElementById('quantite');
    const quantiteParCategorie = {{ produit.quantite_par_categorie | default(0) }};

    // Fonction pour calculer le prix total (prix fixe)
    function calculateTotalPrice() {
        const quantity = parseInt(quantityInput.value) || 1;
        return basePrice * quantity;
    }

    // Mettre √† jour le prix en temps r√©el
    function updatePrice() {
        const totalPrice = calculateTotalPrice();
        currentPriceElement.textContent = totalPrice + ' KMF';
    }

    // Validation des s√©lections (modifi√©e pour √™tre moins stricte)
    function validateSelections() {
        if (quantiteParCategorie > 0) {
            // Pour les s√©lections multiples, v√©rifier qu'il y a au moins une s√©lection par cat√©gorie
            const categories = form.querySelectorAll('.accordion-section');
            for (const category of categories) {
                const checkboxes = category.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    return false;
                }
            }
        } else {
            // Validation pour s√©lections uniques (radio buttons)
            const categories = form.querySelectorAll('.accordion-section');
            for (const category of categories) {
                const radioChecked = category.querySelector('input[type="radio"]:checked');
                if (!radioChecked) {
                    return false;
                }
            }
        }
        return true;
    }

    // Limiter les s√©lections multiples (modification pour permettre le changement)
    function limitSelections() {
        if (quantiteParCategorie > 0) {
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const category = this.name;
                    const categoryCheckboxes = form.querySelectorAll(`input[name="${category}"]`);
                    const checkedBoxes = form.querySelectorAll(`input[name="${category}"]:checked`);

                    // Permettre de changer les s√©lections librement
                    // Ne pas limiter si on d√©coche
                    if (!this.checked) {
                        return;
                    }

                    // Si on essaie de cocher et qu'on d√©passe la limite, d√©coche automatiquement l'ancienne s√©lection
                    if (checkedBoxes.length > quantiteParCategorie) {
                        // D√©coche toutes les cases de cette cat√©gorie
                        categoryCheckboxes.forEach(cb => cb.checked = false);
                        // Recoche seulement celle-ci
                        this.checked = true;
                    }

                    // V√©rifier si toutes les cat√©gories sont s√©lectionn√©es avant de scroller
                    checkAndScrollToButton();
                });
            });
        } else {
            // Pour les radio buttons, permettre le changement libre
            const radioButtons = form.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // V√©rifier si toutes les cat√©gories sont s√©lectionn√©es avant de scroller
                    checkAndScrollToButton();
                });
            });
        }
    }

    // Variable pour suivre si le scroll a d√©j√† √©t√© fait
    let hasScrolledToButton = false;

    // Fonction pour v√©rifier si toutes les cat√©gories sont s√©lectionn√©es et scroller si oui
    function checkAndScrollToButton() {
        if (hasScrolledToButton) return; // Ne scroll qu'une seule fois

        const allCategoriesComplete = checkIfAllCategoriesComplete();
        if (allCategoriesComplete) {
            scrollToAddButton();
        }
    }

    // Fonction pour v√©rifier si toutes les cat√©gories ont le bon nombre de s√©lections
    function checkIfAllCategoriesComplete() {
        if (quantiteParCategorie > 0) {
            // Pour les s√©lections multiples, v√©rifier qu'il y a exactement le bon nombre par cat√©gorie
            const categories = form.querySelectorAll('.accordion-section');
            for (const category of categories) {
                const checkboxes = category.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length !== quantiteParCategorie) {
                    return false;
                }
            }
        } else {
            // Validation pour s√©lections uniques (radio buttons)
            const categories = form.querySelectorAll('.accordion-section');
            for (const category of categories) {
                const radioChecked = category.querySelector('input[type="radio"]:checked');
                if (!radioChecked) {
                    return false;
                }
            }
        }
        return true;
    }

    // Fonction pour scroller vers le bouton "Ajouter au panier"
    function scrollToAddButton() {
        const addButton = document.querySelector('.btn-primary[type="submit"]');
        if (addButton) {
            addButton.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
            hasScrolledToButton = true;
        }
    }

    // Gestion de l'accord√©on
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    accordionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            const icon = this.querySelector('.accordion-icon');
            
            // Toggle content visibility
            content.classList.toggle('open');
            
            // Update icon
            if (content.classList.contains('open')) {
                icon.textContent = '‚ñ≤';
            } else {
                icon.textContent = '‚ñº';
            }
        });
    });

    // Ouvrir la premi√®re section par d√©faut (pour desktop et mobile)
    if (accordionHeaders.length > 0) {
        const firstContent = accordionHeaders[0].nextElementSibling;
        const firstIcon = accordionHeaders[0].querySelector('.accordion-icon');
        firstContent.classList.add('open');
        firstIcon.textContent = '‚ñ≤';
        console.log('Premier accord√©on ouvert par d√©faut');
    }
    
    // Initialiser les limitations
    limitSelections();

    // Gestionnaire de soumission du formulaire
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('üîµ D√©but de la soumission du formulaire');

        if (!validateSelections()) {
            if (quantiteParCategorie > 0) {
                alert('Veuillez s√©lectionner au moins un √©l√©ment dans chaque cat√©gorie.');
            } else {
                alert('Veuillez s√©lectionner une option pour chaque cat√©gorie.');
            }
            return;
        }
        
        console.log('‚úÖ Validation r√©ussie');

        const selectedOptions = {};
        
        if (quantiteParCategorie > 0) {
            // Collecter les s√©lections multiples
            const categories = form.querySelectorAll('.accordion-section');
            categories.forEach(category => {
                const checkbox = category.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    const categoryName = checkbox.name;
                    const selectedCheckboxes = category.querySelectorAll('input[type="checkbox"]:checked');
                    if (selectedCheckboxes.length > 0) {
                        selectedOptions[categoryName] = Array.from(selectedCheckboxes).map(cb => cb.value);
                    }
                }
            });
        } else {
            // Collecter les s√©lections uniques
            const radioButtons = form.querySelectorAll('input[type="radio"]:checked');
            radioButtons.forEach(radio => {
                selectedOptions[radio.name] = radio.value;
            });
        }
        
        console.log('üì¶ Options s√©lectionn√©es:', selectedOptions);

        const quantity = parseInt(quantityInput.value) || 1;
        const totalPrice = calculateTotalPrice();

        // Cr√©er l'objet produit personnalis√©
        const customizedProduct = {
            id: 'custom-' + Date.now(),
            product_id: 'custom-' + Date.now(),
            nom: '{{ produit.nom }} (Personnalis√©)',
            prix: totalPrice,
            image: '{{ produit.image }}',
            quantite: quantity,
            type: 'personnalise',
            product_type: 'personnalise',
            options: selectedOptions,
            baseProductId: {{ produit.id | tojson }}
        };
        
        console.log('üõí Produit √† ajouter:', customizedProduct);

        try {
            // Ajouter au panier
            const success = await panier.ajouter(customizedProduct);
            
            console.log('üì® R√©sultat de l\'ajout:', success);
            
            if (success) {
                // Afficher un message de confirmation
                afficherMessage('Produit personnalis√© ajout√© au panier !', 'success');

                // Rediriger vers le panier apr√®s un court d√©lai
                setTimeout(() => {
                    window.location.href = '{{ url_for("panier") }}';
                }, 1500);
            } else {
                console.error('‚ùå √âchec de l\'ajout au panier');
                afficherMessage('Erreur lors de l\'ajout au panier. Veuillez r√©essayer.', 'error');
            }
        } catch (error) {
            console.error('üí• Erreur exception:', error);
            afficherMessage('Erreur lors de l\'ajout au panier: ' + error.message, 'error');
        }
    });
});
</script>
{% endblock %}
