{% extends 'base.html' %}

{% block title %}Mes Favoris - Colourful HDJT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile-mobile.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-indigo-50">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-pink-500 via-purple-600 to-indigo-600 text-white">
        <div class="container mx-auto px-4 py-16">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="mb-8 md:mb-0">
                        <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-white to-pink-100 bg-clip-text text-transparent">
                            Mes Favoris ‚ù§Ô∏è
                        </h1>
                        <p class="text-xl text-pink-100 max-w-2xl">
                            Vos produits pr√©f√©r√©s sauvegard√©s pour vos prochains achats.
                        </p>
                    </div>
                    <div class="relative">
                        <div class="w-32 h-32 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/30">
                            <span class="text-6xl">‚ù§Ô∏è</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12">
        <div class="max-w-6xl mx-auto">
            <!-- Menu mobile -->
            <div class="lg:hidden mb-6">
                <button id="mobile-menu-btn" class="w-full bg-white rounded-2xl shadow-lg p-4 flex items-center justify-between hover:shadow-xl transition-all duration-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-xl">‚ù§Ô∏è</span>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800">Navigation rapide</div>
                            <div class="text-sm text-gray-500">Acc√©der aux sections</div>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-lg" id="menu-icon">‚ò∞</span>
                    </div>
                </button>

                <!-- Menu mobile d√©roulant -->
                <div id="mobile-menu" class="hidden bg-white rounded-2xl shadow-xl mt-2 overflow-hidden">
                    <nav class="divide-y divide-gray-100">
                        <a href="{{ url_for('profile') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üë§</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mon profil</div>
                                <div class="text-sm text-gray-500">Vue d'ensemble</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_orders') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üì¶</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes commandes</div>
                                <div class="text-sm text-gray-500">Historique et suivi</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_favorites') }}" class="flex items-center px-6 py-4 bg-purple-50 text-purple-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">‚ù§Ô∏è</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes favoris</div>
                                <div class="text-sm text-purple-500">Produits pr√©f√©r√©s</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_addresses') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üìç</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes adresses</div>
                                <div class="text-sm text-gray-500">Livraison et facturation</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_settings') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">‚öôÔ∏è</span>
                            </div>
                            <div>
                                <div class="font-semibold">Param√®tres</div>
                                <div class="text-sm text-gray-500">Pr√©f√©rences et s√©curit√©</div>
                            </div>
                        </a>

                        <a href="{{ url_for('logout') }}" class="flex items-center px-6 py-4 text-red-600 hover:bg-red-50 transition-all duration-200">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üö™</span>
                            </div>
                            <div>
                                <div class="font-semibold">D√©connexion</div>
                                <div class="text-sm text-red-500">Se d√©connecter du compte</div>
                            </div>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Vue d'ensemble -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Navigation rapide - Desktop -->
                <div class="hidden lg:block lg:col-span-1">
                    <div class="bg-white rounded-3xl shadow-xl p-6 sticky top-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Navigation rapide</h3>
                        <nav class="space-y-4">
                            <a href="{{ url_for('profile') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-pink-200 transition-colors">
                                    <span class="text-xl">üë§</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mon profil</div>
                                    <div class="text-sm text-gray-500">Vue d'ensemble</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_orders') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-pink-200 transition-colors">
                                    <span class="text-xl">üì¶</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes commandes</div>
                                    <div class="text-sm text-gray-500">Historique et suivi</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_favorites') }}" class="flex items-center px-4 py-4 rounded-xl bg-purple-50 text-purple-600 transition-all duration-200">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-xl">‚ù§Ô∏è</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes favoris</div>
                                    <div class="text-sm text-purple-500">Produits pr√©f√©r√©s</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_addresses') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-indigo-200 transition-colors">
                                    <span class="text-xl">üìç</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes adresses</div>
                                    <div class="text-sm text-gray-500">Livraison et facturation</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_settings') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-indigo-200 transition-colors">
                                    <span class="text-xl">‚öôÔ∏è</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Param√®tres</div>
                                    <div class="text-sm text-gray-500">Pr√©f√©rences et s√©curit√©</div>
                                </div>
                            </a>

                            <div class="border-t border-gray-200 my-6"></div>

                            <a href="{{ url_for('logout') }}" class="flex items-center px-4 py-4 rounded-xl text-red-600 hover:bg-red-50 transition-all duration-200 font-medium">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-xl">üö™</span>
                                </div>
                                <div>
                                    <div class="font-semibold">D√©connexion</div>
                                    <div class="text-sm text-red-500">Se d√©connecter du compte</div>
                                </div>
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Contenu principal -->
                <div class="lg:col-span-2 space-y-8">
            <!-- Grille des favoris -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- √âtat vide -->
                <div class="col-span-full">
                    <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                        <div class="w-24 h-24 mx-auto bg-gradient-to-br from-red-100 to-pink-100 rounded-full flex items-center justify-center mb-6">
                            <span class="text-6xl">üíñ</span>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Aucun favori enregistr√©</h2>
                        <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">
                            Marquez vos produits pr√©f√©r√©s pour les retrouver facilement et suivre les promotions !
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <a href="{{ url_for('produits') }}" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-red-500 to-pink-600 text-white font-semibold rounded-xl hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                                <span class="mr-2">‚ù§Ô∏è</span>
                                D√©couvrir les produits
                            </a>
                            <a href="{{ url_for('creer_contenant') }}" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                                <span class="mr-2">üé®</span>
                                Cr√©er un contenant personnalis√©
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Exemple de produit favori (√† supprimer quand il y aura des vrais favoris) -->
                <!--
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                    <div class="relative">
                        <img src="https://via.placeholder.com/300x300?text=Rouge+√†+l√®vres" alt="Rouge √† l√®vres MAC"
                             class="w-full h-48 object-cover">
                        <button class="absolute top-3 right-3 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-red-50 transition-colors">
                            <span class="text-red-500 text-xl">‚ù§Ô∏è</span>
                        </button>
                        <div class="absolute top-3 left-3">
                            <span class="px-2 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">Nouveau</span>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="mb-2">
                            <span class="px-2 py-1 bg-pink-100 text-pink-800 text-xs font-medium rounded-full">Rouge √† l√®vres</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Rouge √† l√®vres MAC Ruby Woo</h3>
                        <p class="text-gray-600 text-sm mb-3">Marque: MAC Cosmetics</p>

                        <div class="flex items-center justify-between">
                            <div class="text-2xl font-bold text-gray-800">8,500 KMF</div>
                            <button class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                                Ajouter au panier
                            </button>
                        </div>
                    </div>
                </div>
                -->
            </div>

            <!-- Suggestions de produits -->
            <div class="mt-16">
                <div class="bg-gradient-to-r from-pink-500 to-purple-600 rounded-2xl p-8 text-white text-center">
                    <h2 class="text-3xl font-bold mb-4">Vous pourriez aimer</h2>
                    <p class="text-xl text-pink-100 mb-8 max-w-2xl mx-auto">
                        D√©couvrez d'autres produits qui pourraient vous int√©resser selon vos pr√©f√©rences
                    </p>
                    <a href="{{ url_for('produits') }}" class="inline-flex items-center px-8 py-4 bg-white text-pink-600 font-semibold rounded-xl hover:bg-gray-100 transition-all duration-200">
                        <span class="mr-2">‚ú®</span>
                        Explorer les suggestions
                        <span class="ml-2">‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Animation pour les cartes de produits */
.hover\:-translate-y-1:hover {
    transform: translateY(-4px);
}

.hover\:shadow-xl:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Animation pour le menu mobile */
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

#mobile-menu {
    animation: slideDown 0.3s ease-out;
}
</style>

<script>
// Charger les favoris au chargement de la page
document.addEventListener('DOMContentLoaded', async function() {
    await syncLocalStorageFavorites();
    loadFavorites();
});

async function syncLocalStorageFavorites() {
    const localFavorites = JSON.parse(localStorage.getItem('favoris') || '[]');
    if (localFavorites.length > 0) {
        try {
            const response = await fetch('/api/favorites/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ favorites: localFavorites.map(id => ({ product_id: id })) })
            });
            
            if (response.ok) {
                // Vider localStorage apr√®s synchronisation
                localStorage.removeItem('favoris');
                console.log('Favoris synchronis√©s depuis localStorage');
            }
        } catch (error) {
            console.error('Erreur lors de la synchronisation:', error);
        }
    }
}

async function loadFavorites() {
    try {
        // R√©cup√©rer les favoris depuis l'API
        const response = await fetch('/api/favorites', {
            credentials: 'include'
        });
        const favorites = await response.json();

        if (!response.ok) {
            console.error('Erreur lors du chargement des favoris:', favorites.error);
            displayEmptyState();
            updateStats(0, 0, 0, 0);
            return;
        }

        if (favorites.length === 0) {
            displayEmptyState();
            updateStats(0, 0, 0, 0);
            return;
        }

        // R√©cup√©rer les d√©tails des produits
        const favoriteProducts = [];
        for (const fav of favorites) {
            try {
                const response = await fetch(`/api/product/${fav.product_id}`);
                if (response.ok) {
                    const product = await response.json();
                    favoriteProducts.push({
                        ...product,
                        favorite_id: fav.id,
                        added_at: fav.added_at
                    });
                }
            } catch (error) {
                console.error(`Erreur lors du chargement du produit ${fav.product_id}:`, error);
            }
        }

        displayFavorites(favoriteProducts);
        updateStats(favoriteProducts);

    } catch (error) {
        console.error('Erreur lors du chargement des favoris:', error);
        displayEmptyState();
    }
}

function displayFavorites(products) {
    const container = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.xl\\:grid-cols-4.gap-6');

    if (products.length === 0) {
        displayEmptyState();
        return;
    }

    let html = '';
    products.forEach(product => {
        const imageUrl = product.image || '/static/images/placeholder.jpg';
        const price = product.prix || product.price || 0;

        html += `
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                <div class="relative">
                    <img src="${imageUrl}" alt="${product.nom}" class="w-full h-48 object-cover">
                    <button onclick="removeFromFavorites('${product.id}')"
                            class="absolute top-3 right-3 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-red-50 transition-colors">
                        <span class="text-red-500 text-lg">√ó</span>
                    </button>
                </div>

                <div class="p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2 line-clamp-2">${product.nom}</h3>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-3">${product.description || 'Description non disponible'}</p>

                    <div class="flex items-center justify-between">
                        <div class="text-2xl font-bold text-pink-600">${price} KMF</div>
                        <a href="/produit/${product.id}"
                           class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-sm font-semibold rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                            Voir d√©tails
                        </a>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function displayEmptyState() {
    const container = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.xl\\:grid-cols-4.gap-6');

    container.innerHTML = `
        <div class="col-span-full">
            <div class="bg-white rounded-2xl shadow-lg p-12 text-center">
                <div class="w-24 h-24 mx-auto bg-gradient-to-br from-red-100 to-pink-100 rounded-full flex items-center justify-center mb-6">
                    <span class="text-6xl">üíñ</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Aucun favori trouv√©</h3>
                <p class="text-gray-600 mb-8 max-w-md mx-auto">
                    Vous n'avez pas encore ajout√© de produits √† vos favoris. D√©couvrez nos produits et ajoutez ceux que vous aimez !
                </p>
                <a href="{{ url_for('produits') }}" class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                    <span class="mr-2">‚ú®</span>
                    Explorer les produits
                    <span class="ml-2">‚Üí</span>
                </a>
            </div>
        </div>
    `;
}

function updateStats(products) {
    // Compter par cat√©gorie
    const makeupCount = products.filter(p => p.categorie?.toLowerCase().includes('maquillage') || p.nom?.toLowerCase().includes('rouge') || p.nom?.toLowerCase().includes('mascara')).length;
    const skincareCount = products.filter(p => p.categorie?.toLowerCase().includes('soin') || p.nom?.toLowerCase().includes('cr√®me') || p.nom?.toLowerCase().includes('huile')).length;

    // Mettre √† jour les statistiques
    const statElements = document.querySelectorAll('.text-3xl.font-bold.text-gray-800');
    if (statElements.length >= 2) {
        statElements[0].textContent = makeupCount;
        statElements[1].textContent = skincareCount;
    }
}

async function removeFromFavorites(productId) {
    try {
        const response = await fetch('/api/favorites', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ product_id: productId })
        });

        const result = await response.json();

        if (response.ok) {
            // Recharger les favoris
            loadFavorites();
            // Afficher une notification
            showNotification('Produit retir√© des favoris', 'success');
        } else {
            showNotification(result.error || 'Erreur lors de la suppression', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('Erreur r√©seau', 'error');
    }
}

function showNotification(message, type = 'info') {
    // Cr√©er une notification temporaire
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-xl text-white font-semibold z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Supprimer apr√®s 3 secondes
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Menu mobile toggle
document.getElementById('mobile-menu-btn').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    const icon = document.getElementById('menu-icon');

    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        icon.textContent = '‚úï';
        this.classList.add('ring-2', 'ring-purple-300');
    } else {
        menu.classList.add('hidden');
        icon.textContent = '‚ò∞';
        this.classList.remove('ring-2', 'ring-purple-300');
    }
});

// Fermer le menu mobile quand on clique ailleurs
document.addEventListener('click', function(event) {
    const menu = document.getElementById('mobile-menu');
    const btn = document.getElementById('mobile-menu-btn');
    const icon = document.getElementById('menu-icon');

    if (!btn.contains(event.target) && !menu.contains(event.target)) {
        menu.classList.add('hidden');
        icon.textContent = '‚ò∞';
        btn.classList.remove('ring-2', 'ring-purple-300');
    }
});
</script>
{% endblock %}