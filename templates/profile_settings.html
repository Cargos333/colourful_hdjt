{% extends 'base.html' %}

{% block title %}Param√®tres - Colourful HDJT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile-mobile.css') }}">
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-indigo-50">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-pink-500 via-purple-600 to-indigo-600 text-white">
        <div class="container mx-auto px-4 py-16">
            <div class="max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="mb-8 md:mb-0">
                        <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-white to-pink-100 bg-clip-text text-transparent">
                            Param√®tres ‚öôÔ∏è
                        </h1>
                        <p class="text-xl text-pink-100 max-w-2xl">
                            G√©rez vos pr√©f√©rences et param√®tres de s√©curit√© du compte.
                        </p>
                    </div>
                    <div class="relative">
                        <div class="w-32 h-32 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center border-4 border-white/30">
                            <span class="text-6xl">‚öôÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12">
        <div class="max-w-6xl mx-auto">
            <!-- Menu mobile -->
            <div class="lg:hidden mb-6">
                <button id="mobile-menu-btn" class="w-full bg-white rounded-2xl shadow-lg p-4 flex items-center justify-between hover:shadow-xl transition-all duration-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-xl">‚öôÔ∏è</span>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800">Navigation rapide</div>
                            <div class="text-sm text-gray-500">Acc√©der aux sections</div>
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-lg" id="menu-icon">‚ò∞</span>
                    </div>
                </button>

                <!-- Menu mobile d√©roulant -->
                <div id="mobile-menu" class="hidden bg-white rounded-2xl shadow-xl mt-2 overflow-hidden">
                    <nav class="divide-y divide-gray-100">
                        <a href="{{ url_for('profile') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üë§</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mon profil</div>
                                <div class="text-sm text-gray-500">Vue d'ensemble</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_orders') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üì¶</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes commandes</div>
                                <div class="text-sm text-gray-500">Historique et suivi</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_favorites') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">‚ù§Ô∏è</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes favoris</div>
                                <div class="text-sm text-gray-500">Produits pr√©f√©r√©s</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_addresses') }}" class="flex items-center px-6 py-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üìç</span>
                            </div>
                            <div>
                                <div class="font-semibold">Mes adresses</div>
                                <div class="text-sm text-gray-500">Livraison et facturation</div>
                            </div>
                        </a>

                        <a href="{{ url_for('profile_settings') }}" class="flex items-center px-6 py-4 bg-indigo-50 text-indigo-600 transition-all duration-200">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">‚öôÔ∏è</span>
                            </div>
                            <div>
                                <div class="font-semibold">Param√®tres</div>
                                <div class="text-sm text-indigo-500">Pr√©f√©rences et s√©curit√©</div>
                            </div>
                        </a>

                        <a href="{{ url_for('logout') }}" class="flex items-center px-6 py-4 text-red-600 hover:bg-red-50 transition-all duration-200">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-xl">üö™</span>
                            </div>
                            <div>
                                <div class="font-semibold">D√©connexion</div>
                                <div class="text-sm text-red-500">Se d√©connecter du compte</div>
                            </div>
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Vue d'ensemble -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Navigation rapide - Desktop -->
                <div class="hidden lg:block lg:col-span-1">
                    <div class="bg-white rounded-3xl shadow-xl p-6 sticky top-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Navigation rapide</h3>
                        <nav class="space-y-4">
                            <a href="{{ url_for('profile') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-pink-200 transition-colors">
                                    <span class="text-xl">üë§</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mon profil</div>
                                    <div class="text-sm text-gray-500">Vue d'ensemble</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_orders') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-pink-50 hover:text-pink-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-pink-200 transition-colors">
                                    <span class="text-xl">üì¶</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes commandes</div>
                                    <div class="text-sm text-gray-500">Historique et suivi</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_favorites') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-purple-200 transition-colors">
                                    <span class="text-xl">‚ù§Ô∏è</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes favoris</div>
                                    <div class="text-sm text-gray-500">Produits pr√©f√©r√©s</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_addresses') }}" class="flex items-center px-4 py-4 rounded-xl text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-all duration-200 group">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3 group-hover:bg-indigo-200 transition-colors">
                                    <span class="text-xl">üìç</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Mes adresses</div>
                                    <div class="text-sm text-gray-500">Livraison et facturation</div>
                                </div>
                            </a>

                            <a href="{{ url_for('profile_settings') }}" class="flex items-center px-4 py-4 rounded-xl bg-indigo-50 text-indigo-600 transition-all duration-200">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-xl">‚öôÔ∏è</span>
                                </div>
                                <div>
                                    <div class="font-semibold">Param√®tres</div>
                                    <div class="text-sm text-indigo-500">Pr√©f√©rences et s√©curit√©</div>
                                </div>
                            </a>

                            <div class="border-t border-gray-200 my-6"></div>

                            <a href="{{ url_for('logout') }}" class="flex items-center px-4 py-4 rounded-xl text-red-600 hover:bg-red-50 transition-all duration-200 font-medium">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-xl">üö™</span>
                                </div>
                                <div>
                                    <div class="font-semibold">D√©connexion</div>
                                    <div class="text-sm text-red-500">Se d√©connecter du compte</div>
                                </div>
                            </a>
                        </nav>
                    </div>
                </div>

                <!-- Contenu principal -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Informations personnelles -->
                    <div class="bg-white rounded-3xl shadow-xl p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 mb-2">Informations personnelles</h2>
                                <p class="text-gray-600">Mettez √† jour vos informations de profil</p>
                            </div>
                            <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">üë§</span>
                            </div>
                        </div>

                        <form class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Pr√©nom</label>
                                    <input type="text" name="prenom" value="{{ session.user_prenom }}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                                    <input type="text" name="nom" value="{{ session.user_nom }}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" name="email" value="{{ session.user_email }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                                <input type="text" name="username" value="{{ session.user_username or '' }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√©l√©phone</label>
                                <input type="tel" name="telephone" value="{{ session.user_telephone or '' }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all">
                            </div>

                            <div class="flex gap-4">
                                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                                    Sauvegarder les modifications
                                </button>
                                <button type="button" class="px-8 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all duration-200">
                                    Annuler
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- S√©curit√© -->
                    <div class="bg-white rounded-3xl shadow-xl p-8">
                        <div class="flex items-center justify-between mb-8">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-800 mb-2">S√©curit√© du compte</h2>
                                <p class="text-gray-600">G√©rez votre mot de passe et la s√©curit√©</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">üîí</span>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-gray-50 rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Changer le mot de passe</h3>
                                <form id="password-form" class="space-y-4" onsubmit="event.preventDefault(); handlePasswordChange(event); return false;">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe actuel</label>
                                        <input type="password" name="current_password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau mot de passe</label>
                                        <input type="password" name="new_password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le nouveau mot de passe</label>
                                        <input type="password" name="confirm_password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                    </div>
                                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                                        Changer le mot de passe
                                    </button>
                                </form>
                            </div>

                            <div class="bg-gray-50 rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Authentification √† deux facteurs</h3>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-600 mb-2">Ajoutez une couche de s√©curit√© suppl√©mentaire</p>
                                        <p class="text-sm text-gray-500">Non activ√©</p>
                                    </div>
                                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                        Activer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zone de danger -->
                    <div class="bg-red-50 border border-red-200 rounded-3xl p-8">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-red-800 mb-2">Zone de danger</h2>
                                <p class="text-red-600">Actions irr√©versibles pour votre compte</p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="space-y-3">
                                <button id="delete-account-btn" type="button" class="w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition-all duration-200">
                                    Supprimer mon compte
                                </button>
                                <div id="delete-confirmation" class="hidden space-y-3">
                                    <div class="bg-red-100 border border-red-300 rounded-xl p-4">
                                        <p class="text-red-800 font-medium mb-2">Confirmer la suppression</p>
                                        <p class="text-sm text-red-700 mb-3">Tapez <strong>SUPPRIMER</strong> pour confirmer :</p>
                                        <input type="text" id="delete-confirm-input" class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Tapez SUPPRIMER">
                                    </div>
                                    <div class="flex space-x-3">
                                        <button id="confirm-delete-btn" type="button" class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-all duration-200">
                                            Confirmer la suppression
                                        </button>
                                        <button id="cancel-delete-btn" type="button" class="flex-1 px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all duration-200">
                                            Annuler
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-red-600 text-center">
                                Cette action est d√©finitive et entra√Ænera la suppression de toutes vos donn√©es.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Animation pour le menu mobile */
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

#mobile-menu {
    animation: slideDown 0.3s ease-out;
}
</style>

<script>
// Gestionnaire pour le formulaire de mise √† jour du profil
document.addEventListener('DOMContentLoaded', function() {
    const profileForm = document.querySelector('form');
    if (profileForm) {
        profileForm.addEventListener('submit', handleProfileUpdate);
    }

    // Gestionnaire pour le formulaire de changement de mot de passe
    const passwordForm = document.getElementById('password-form');
    if (passwordForm) {
        if (typeof handlePasswordChange === 'function') {
            passwordForm.addEventListener('submit', handlePasswordChange);
        }
    }

    // Gestionnaire pour la suppression du compte
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const deleteConfirmation = document.getElementById('delete-confirmation');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const deleteConfirmInput = document.getElementById('delete-confirm-input');

    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', function() {
            deleteConfirmation.classList.remove('hidden');
            deleteAccountBtn.classList.add('hidden');
        });
    }

    if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', function() {
            deleteConfirmation.classList.add('hidden');
            deleteAccountBtn.classList.remove('hidden');
            deleteConfirmInput.value = '';
        });
    }

    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', function() {
            const confirmText = deleteConfirmInput.value.trim();
            if (confirmText === 'SUPPRIMER') {
                handleDeleteAccount();
            } else {
                showNotification('Veuillez taper "SUPPRIMER" pour confirmer', 'error');
            }
        });
    }
});

async function handleProfileUpdate(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        prenom: formData.get('prenom'),
        nom: formData.get('nom'),
        email: formData.get('email'),
        username: formData.get('username'),
        telephone: formData.get('telephone')
    };

    try {
        const response = await fetch('/api/auth/update-profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showNotification('Profil mis √† jour avec succ√®s !', 'success');
            // Recharger la page apr√®s un court d√©lai pour voir les changements
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification(result.error || 'Erreur lors de la mise √† jour du profil', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('Erreur r√©seau lors de la mise √† jour du profil', 'error');
    }
}

async function handlePasswordChange(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        current_password: formData.get('current_password'),
        new_password: formData.get('new_password'),
        confirm_password: formData.get('confirm_password')
    };

    // Validation c√¥t√© client
    if (data.new_password !== data.confirm_password) {
        showNotification('Les mots de passe ne correspondent pas', 'error');
        return;
    }

    if (data.new_password.length < 6) {
        showNotification('Le nouveau mot de passe doit contenir au moins 6 caract√®res', 'error');
        return;
    }

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showNotification('Mot de passe chang√© avec succ√®s !', 'success');
            event.target.reset();
        } else {
            showNotification(result.error || 'Erreur lors du changement de mot de passe', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('Erreur r√©seau lors du changement de mot de passe', 'error');
    }
}

async function handleDeleteAccount() {
    try {
        const response = await fetch('/api/auth/delete-account', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        });

        if (response.ok) {
            showNotification('Compte supprim√© avec succ√®s', 'success');
            // Rediriger vers la page d'accueil apr√®s un d√©lai
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            const result = await response.json();
            showNotification(result.error || 'Erreur lors de la suppression du compte', 'error');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('Erreur r√©seau lors de la suppression du compte', 'error');
    }
}

function showNotification(message, type = 'info') {
    // Supprimer les notifications existantes
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // Cr√©er une nouvelle notification
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 px-6 py-3 rounded-xl text-white font-semibold z-50 transform translate-x-full transition-transform duration-300 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Animation d'entr√©e
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Supprimer apr√®s 5 secondes
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 5000);
}

// Menu mobile toggle
document.getElementById('mobile-menu-btn').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    const icon = document.getElementById('menu-icon');

    if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
        icon.textContent = '‚úï';
        this.classList.add('ring-2', 'ring-indigo-300');
    } else {
        menu.classList.add('hidden');
        icon.textContent = '‚ò∞';
        this.classList.remove('ring-2', 'ring-indigo-300');
    }
});

// Fermer le menu mobile quand on clique ailleurs
document.addEventListener('click', function(event) {
    const menu = document.getElementById('mobile-menu');
    const btn = document.getElementById('mobile-menu-btn');
    const icon = document.getElementById('menu-icon');

    if (!btn.contains(event.target) && !menu.contains(event.target)) {
        menu.classList.add('hidden');
        icon.textContent = '‚ò∞';
        btn.classList.remove('ring-2', 'ring-indigo-300');
    }
});
</script>
</script>
{% endblock %}